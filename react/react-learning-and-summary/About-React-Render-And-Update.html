<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>About React Render And Update(个人见解) | Learing And Sharing</title>
    <meta name="description" content="好好学习，天天向上💪">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/keep-Learning/assets/css/0.styles.69d11f16.css" as="style"><link rel="preload" href="/keep-Learning/assets/js/app.90ccec97.js" as="script"><link rel="preload" href="/keep-Learning/assets/js/2.71580b53.js" as="script"><link rel="preload" href="/keep-Learning/assets/js/79.83c1ce53.js" as="script"><link rel="prefetch" href="/keep-Learning/assets/js/10.99f30dcf.js"><link rel="prefetch" href="/keep-Learning/assets/js/100.53100d9a.js"><link rel="prefetch" href="/keep-Learning/assets/js/101.02f72051.js"><link rel="prefetch" href="/keep-Learning/assets/js/102.60bb996e.js"><link rel="prefetch" href="/keep-Learning/assets/js/103.c7f3df5b.js"><link rel="prefetch" href="/keep-Learning/assets/js/104.e8378220.js"><link rel="prefetch" href="/keep-Learning/assets/js/105.90235e89.js"><link rel="prefetch" href="/keep-Learning/assets/js/106.f4905ea3.js"><link rel="prefetch" href="/keep-Learning/assets/js/107.02dfbd1b.js"><link rel="prefetch" href="/keep-Learning/assets/js/108.e4ffed8c.js"><link rel="prefetch" href="/keep-Learning/assets/js/109.2f6191db.js"><link rel="prefetch" href="/keep-Learning/assets/js/11.ccfc084d.js"><link rel="prefetch" href="/keep-Learning/assets/js/110.05776fb6.js"><link rel="prefetch" href="/keep-Learning/assets/js/111.b05f070d.js"><link rel="prefetch" href="/keep-Learning/assets/js/112.e07a4e74.js"><link rel="prefetch" href="/keep-Learning/assets/js/113.71af1d2b.js"><link rel="prefetch" href="/keep-Learning/assets/js/114.914195f4.js"><link rel="prefetch" href="/keep-Learning/assets/js/115.3a0e92aa.js"><link rel="prefetch" href="/keep-Learning/assets/js/116.4ab80baa.js"><link rel="prefetch" href="/keep-Learning/assets/js/12.5bee8056.js"><link rel="prefetch" href="/keep-Learning/assets/js/13.05de0df0.js"><link rel="prefetch" href="/keep-Learning/assets/js/14.d86b4a20.js"><link rel="prefetch" href="/keep-Learning/assets/js/15.887efa99.js"><link rel="prefetch" href="/keep-Learning/assets/js/16.f7c7fa8d.js"><link rel="prefetch" href="/keep-Learning/assets/js/17.dbf7a65f.js"><link rel="prefetch" href="/keep-Learning/assets/js/18.e57690bf.js"><link rel="prefetch" href="/keep-Learning/assets/js/19.7486ada7.js"><link rel="prefetch" href="/keep-Learning/assets/js/20.d9250e4c.js"><link rel="prefetch" href="/keep-Learning/assets/js/21.71046546.js"><link rel="prefetch" href="/keep-Learning/assets/js/22.5d1bafeb.js"><link rel="prefetch" href="/keep-Learning/assets/js/23.06f0e746.js"><link rel="prefetch" href="/keep-Learning/assets/js/24.2d27300f.js"><link rel="prefetch" href="/keep-Learning/assets/js/25.08ee3872.js"><link rel="prefetch" href="/keep-Learning/assets/js/26.b747bff1.js"><link rel="prefetch" href="/keep-Learning/assets/js/27.895e5c28.js"><link rel="prefetch" href="/keep-Learning/assets/js/28.8674bd28.js"><link rel="prefetch" href="/keep-Learning/assets/js/29.00b3c0e2.js"><link rel="prefetch" href="/keep-Learning/assets/js/3.227fd7b0.js"><link rel="prefetch" href="/keep-Learning/assets/js/30.7c8a2e90.js"><link rel="prefetch" href="/keep-Learning/assets/js/31.4e94fa86.js"><link rel="prefetch" href="/keep-Learning/assets/js/32.24db43de.js"><link rel="prefetch" href="/keep-Learning/assets/js/33.3a9d7c5b.js"><link rel="prefetch" href="/keep-Learning/assets/js/34.455ff1fa.js"><link rel="prefetch" href="/keep-Learning/assets/js/35.bf04ef16.js"><link rel="prefetch" href="/keep-Learning/assets/js/36.f733bfb6.js"><link rel="prefetch" href="/keep-Learning/assets/js/37.507ec8ee.js"><link rel="prefetch" href="/keep-Learning/assets/js/38.4c8024fc.js"><link rel="prefetch" href="/keep-Learning/assets/js/39.e5094649.js"><link rel="prefetch" href="/keep-Learning/assets/js/4.c62e84b3.js"><link rel="prefetch" href="/keep-Learning/assets/js/40.6dd7a473.js"><link rel="prefetch" href="/keep-Learning/assets/js/41.14db9a5d.js"><link rel="prefetch" href="/keep-Learning/assets/js/42.342c49d2.js"><link rel="prefetch" href="/keep-Learning/assets/js/43.e2f02df0.js"><link rel="prefetch" href="/keep-Learning/assets/js/44.85c43572.js"><link rel="prefetch" href="/keep-Learning/assets/js/45.2d71b584.js"><link rel="prefetch" href="/keep-Learning/assets/js/46.26841be2.js"><link rel="prefetch" href="/keep-Learning/assets/js/47.2be49ff6.js"><link rel="prefetch" href="/keep-Learning/assets/js/48.b0982983.js"><link rel="prefetch" href="/keep-Learning/assets/js/49.0160ec63.js"><link rel="prefetch" href="/keep-Learning/assets/js/5.c9cb8de9.js"><link rel="prefetch" href="/keep-Learning/assets/js/50.d1a3af12.js"><link rel="prefetch" href="/keep-Learning/assets/js/51.a655886f.js"><link rel="prefetch" href="/keep-Learning/assets/js/52.93851e74.js"><link rel="prefetch" href="/keep-Learning/assets/js/53.c8009c28.js"><link rel="prefetch" href="/keep-Learning/assets/js/54.7945804f.js"><link rel="prefetch" href="/keep-Learning/assets/js/55.0d1b82a0.js"><link rel="prefetch" href="/keep-Learning/assets/js/56.ea4f3968.js"><link rel="prefetch" href="/keep-Learning/assets/js/57.c7fe55e7.js"><link rel="prefetch" href="/keep-Learning/assets/js/58.e2e1b6dd.js"><link rel="prefetch" href="/keep-Learning/assets/js/59.195b09a3.js"><link rel="prefetch" href="/keep-Learning/assets/js/6.7294f365.js"><link rel="prefetch" href="/keep-Learning/assets/js/60.b0c6ca2b.js"><link rel="prefetch" href="/keep-Learning/assets/js/61.d8137606.js"><link rel="prefetch" href="/keep-Learning/assets/js/62.354a6c3b.js"><link rel="prefetch" href="/keep-Learning/assets/js/63.42a16259.js"><link rel="prefetch" href="/keep-Learning/assets/js/64.44130cd9.js"><link rel="prefetch" href="/keep-Learning/assets/js/65.826334d1.js"><link rel="prefetch" href="/keep-Learning/assets/js/66.39bd2327.js"><link rel="prefetch" href="/keep-Learning/assets/js/67.89147bbe.js"><link rel="prefetch" href="/keep-Learning/assets/js/68.a7602bd4.js"><link rel="prefetch" href="/keep-Learning/assets/js/69.028f1340.js"><link rel="prefetch" href="/keep-Learning/assets/js/7.a9fa44ec.js"><link rel="prefetch" href="/keep-Learning/assets/js/70.3bb91667.js"><link rel="prefetch" href="/keep-Learning/assets/js/71.65fb15dd.js"><link rel="prefetch" href="/keep-Learning/assets/js/72.00066c85.js"><link rel="prefetch" href="/keep-Learning/assets/js/73.47b522ff.js"><link rel="prefetch" href="/keep-Learning/assets/js/74.7a6ef089.js"><link rel="prefetch" href="/keep-Learning/assets/js/75.b187d3a1.js"><link rel="prefetch" href="/keep-Learning/assets/js/76.88a347ac.js"><link rel="prefetch" href="/keep-Learning/assets/js/77.6f86a34a.js"><link rel="prefetch" href="/keep-Learning/assets/js/78.d0ed26d6.js"><link rel="prefetch" href="/keep-Learning/assets/js/8.acbc06dd.js"><link rel="prefetch" href="/keep-Learning/assets/js/80.a48aa37a.js"><link rel="prefetch" href="/keep-Learning/assets/js/81.6eacd104.js"><link rel="prefetch" href="/keep-Learning/assets/js/82.25ef373b.js"><link rel="prefetch" href="/keep-Learning/assets/js/83.09550954.js"><link rel="prefetch" href="/keep-Learning/assets/js/84.e8671abc.js"><link rel="prefetch" href="/keep-Learning/assets/js/85.b1b7d209.js"><link rel="prefetch" href="/keep-Learning/assets/js/86.d297bac9.js"><link rel="prefetch" href="/keep-Learning/assets/js/87.eeea66b3.js"><link rel="prefetch" href="/keep-Learning/assets/js/88.0ea72a36.js"><link rel="prefetch" href="/keep-Learning/assets/js/89.4155e98e.js"><link rel="prefetch" href="/keep-Learning/assets/js/9.ad2f8d07.js"><link rel="prefetch" href="/keep-Learning/assets/js/90.611a7011.js"><link rel="prefetch" href="/keep-Learning/assets/js/91.e84d85cf.js"><link rel="prefetch" href="/keep-Learning/assets/js/92.30b75a79.js"><link rel="prefetch" href="/keep-Learning/assets/js/93.0ccb8db1.js"><link rel="prefetch" href="/keep-Learning/assets/js/94.f5e0fbaf.js"><link rel="prefetch" href="/keep-Learning/assets/js/95.7e23aad8.js"><link rel="prefetch" href="/keep-Learning/assets/js/96.654c8e0c.js"><link rel="prefetch" href="/keep-Learning/assets/js/97.b65e23fb.js"><link rel="prefetch" href="/keep-Learning/assets/js/98.e14a8d6c.js"><link rel="prefetch" href="/keep-Learning/assets/js/99.e2ce5525.js">
    <link rel="stylesheet" href="/keep-Learning/assets/css/0.styles.69d11f16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/keep-Learning/" class="home-link router-link-active"><!----> <span class="site-name">Learing And Sharing</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/keep-Learning/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分享" class="dropdown-title"><span class="title">技术分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/keep-Learning/javascript/javascript-learning-and-summary/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/html/html-learning-and-summary/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/css/css-learning-and-summary/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/react/" class="nav-link router-link-active">
  React
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/webpack/webpack-learning-and-summary/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/ts/ts-learning-and-summary/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/nodejs/nodejs-learning-and-summary/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/weex/weex-learning-and-summary/" class="nav-link">
  Weex
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/network/network-learning-and-summary/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/datastructure/datastructure-learning-and-summary/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/mixin/mixin-learning-and-summary/" class="nav-link">
  日常杂记
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Andraw-lin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/keep-Learning/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分享" class="dropdown-title"><span class="title">技术分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/keep-Learning/javascript/javascript-learning-and-summary/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/html/html-learning-and-summary/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/css/css-learning-and-summary/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/react/" class="nav-link router-link-active">
  React
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/webpack/webpack-learning-and-summary/" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/ts/ts-learning-and-summary/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/nodejs/nodejs-learning-and-summary/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/weex/weex-learning-and-summary/" class="nav-link">
  Weex
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/network/network-learning-and-summary/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/datastructure/datastructure-learning-and-summary/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/mixin/mixin-learning-and-summary/" class="nav-link">
  日常杂记
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Andraw-lin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/keep-Learning/react/react-learning-and-summary" class="sidebar-heading clickable router-link-active open"><span>React 学习和总结</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keep-Learning/react/react-learning-and-summary/About-React-Render-And-Update.html" class="active sidebar-link">个人见解之 React 渲染与更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/keep-Learning/react/react-learning-and-summary/About-React-Render-And-Update.html#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/react/react-learning-and-summary/About-React-Render-And-Update.html#render（渲染）" class="sidebar-link">Render（渲染）</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/react/react-learning-and-summary/About-React-Render-And-Update.html#update（更新之调度任务）" class="sidebar-link">Update（更新之调度任务）</a></li></ul></li><li><a href="/keep-Learning/react/react-learning-and-summary/React-Summary.html" class="sidebar-link">React 知识点总结</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="about-react-render-and-update-个人见解"><a href="#about-react-render-and-update-个人见解" class="header-anchor">#</a> About React Render And Update(个人见解)</h1> <p><code>React</code>主打函数式思想，设计理念就是<code>all in js</code>，另外推崇的是数据不可变性，所有的数据更新都需手动去操作，便于提高应用的可控性。</p> <p>本文就是以<code>React</code>为主体，简单滴谈一谈个人对于<code>React</code>在渲染层面以及更新层面的一些见解，当中难免会出现一些错误的观点，还请各位童鞋大大们多多指点一下哈 🙈。</p> <h2 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h2> <ol><li><p><a href="#1">Render（渲染）</a></p> <p>1.1 <a href="#11">第一次渲染情况</a></p> <p>1.2 <a href="#12">后续渲染情况</a></p></li> <li><p><a href="#2">Update（更新之调度任务）</a></p></li></ol> <h2 id="render（渲染）"><a href="#render（渲染）" class="header-anchor">#</a> Render（渲染）</h2> <p>在分析<code>Render</code>前，我先引一段代码。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>component</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// 省略</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>相信大家对于上述这坨代码尤为熟悉，不管编写的<code>App</code>组件有多复杂，终究都会通过<code>React.render</code>方法来挂载到相应的<code>DOM</code>元素下。</p> <p>那么问题来了，在<code>ReactDOM.render</code>方法中究竟发生了什么事情？</p> <p>在这里，我会说明一下，<code>Render</code>过程中会分为两种情况，分别是：</p> <ul><li><strong>第一次渲染情况，从<code>root</code>开始，先创建一个<code>Virtual DOM</code>，再直接渲染出一个真实<code>DOM</code></strong>。</li> <li><strong>后续渲染情况，先创建一个新<code>Virtual DOM</code>，与旧<code>Virtual DOM</code>进行<code>diff</code>，再批量滴渲染到真实<code>DOM</code>中</strong>。</li></ul> <blockquote><p><span id="11">第一次渲染情况</span></p></blockquote> <p>先来看看第一次渲染情况中到底发生了什么事情？下面我就不对源码贴出，直接说出来（当中对于部分不理解童鞋难免会有些难以理解，后面有时间我会单独讲讲<code>React</code>源码哈～）</p> <ol><li><p>首先在调用<code>ReactDOM.render</code>时，其内部会执行一个<code>legacyRenderSubtreeIntoContainer</code>方法，该方法会判断是否已存在<code>root</code>。</p></li> <li><p>当判断不存在<code>root</code>时，就会使用<code>legacyCreateRootFromDOMContainer</code>方法创建一个<code>root</code>对象，并挂载在<code>container._reactRootContainer</code>（即<code>document.querySelector('#root')._reactRootContainer</code>）中。</p></li> <li><p>在方法<code>legacyCreateRootFromDOMContainer</code>中，会先将容器内部的所有节点进行移除。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在很多情况下，我们我像上面这样去编写根模板。接着就会<strong>使用<code>ReactRoot</code>构造函数创建<code>root</code>对象</strong>。（即**<code>root</code>对象 --&gt; <code>new ReactRoot()</code>**）。</p></li> <li><p>在构造函数<code>ReactRoot</code>中，会使用<code>createContainer</code>方法创建一个<code>FiberRoot</code>对象，并挂载在<code>root</code>对象的<code>_internalRoot</code>属性中，其中<code>createContainer</code>方法使用的是<code>createFiberRoot</code>方法创建。</p> <p>需要说明的是，<strong><code>fiber</code>是一个树结构，和<code>DOM</code>树中节点一一对应，即每一个<code>DOM</code>节点都会对应一个<code>fiber</code>对象，而<code>FiberRoot</code>对象对应根节点<code>Root</code></strong>。</p></li> <li><p>在<code>createFiberRoot</code>方法中，使用<code>FiberRootNode</code>构造函数创建<code>FiberRoot</code>对象，然后使用<code>createHostRootFiber</code>方法创建一个<code>RootFiber</code>对象，并挂载到<code>FiberRoot</code>对象的<code>current</code>属性中（<strong>即<code>FiberRoot.current === RootFiber</code></strong>）。</p></li> <li><p>对于<code>FiberRoot</code>对象，只需理解其两个属性，分别是<code>containerInfo</code>和<code>current</code>属性。其中前者代表是<code>document.querySelector('#root')</code>，后者代表的是<code>RootFiber</code>。</p></li> <li><p>对于<code>RootFiber</code>对象，我们先来看看要理解的属性。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  stateNode<span class="token punctuation">:</span> any<span class="token punctuation">,</span>
  <span class="token keyword">return</span><span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  child<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  sibling<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  effectTag<span class="token punctuation">:</span> SideEffectTag<span class="token punctuation">,</span>
  alternate<span class="token punctuation">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>stateNode：指向<code>FiberRoot</code>对象。</li> <li>return：指向当前节点的父节点。</li> <li>child：指向当前节点的子节点。</li> <li>sibling：指向当前节点的兄弟节点。</li> <li>effectTag：指代记录<code>DOM</code>操作，如增删改。</li> <li>alternate：指向其旧树对应的节点。需要清楚的是，<strong>存在新旧两个<code>fiber</code>树，旧树称为<code>old tree</code>，新树称为<code>workInProgress tree</code>，其中前者代表渲染好的<code>DOM</code>树，后者则代表正在执行更新的<code>fiber</code>树，当更新结束后，<code>workInProgress tree</code>将会替换<code>old tree</code></strong>。</li></ul></li></ol> <p>下面我们就以一张图简单看看下面这段代码在第一次渲染时，所存在的关系。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
  	<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/Andraw-lin/keep-Learning/master/asset/React%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93%E5%85%B3%E7%B3%BB%E5%9B%BE.jpg" alt="React第一次渲染关系图"></p> <blockquote><p><span id="12">后续渲染情况</span></p></blockquote> <p>接下来就要说的就是后续渲染情况，上面已经说过，当发现已经存在旧的<code>Virtual DOM</code>后（即已存在<code>root</code>对象），则会创建一个新的<code>Virtual DOM</code>，并且通过<code>diff</code>算法，批量更新到真实<code>DOM</code>中。</p> <p>那么在后续的渲染过程中，又是如何处理的？我们接着看 🤔</p> <ol><li><p>由于已存在<code>root</code>对象（即<code>new ReactRoot()</code>），会直接调用<code>root.render(children, callback)</code>方法（即<code>ReactRoot.prototype.render</code>）。在该方法中，首先先取得<code>root._internalRoot</code>即<code>FiberRoot</code>对象，然后直接构建<code>new ReactWork()</code>（该构建对象作用是便于组件渲染或更新后把<code>render</code>中的<code>callback</code>全部调用一遍）。</p></li> <li><p>接着调用<code>updateContainer</code>方法，该方法中会通过<code>FiberRoot</code>对象中的<code>current</code>属性获取到<code>fiber tree</code>（即旧树）。然后通过<code>requestCurrentTime</code>方法计算<code>currentTime</code>任务的当前时间，通过<code>computeExpirationForFiber</code>方法计算任务过期时间。</p></li> <li><p>在方法<code>requestCurrentTime</code>中，通过<code>performance.now() - orginalStartTimeMs</code>得到<code>currentTime</code>当前时间，其中<code>performance.now()</code>是当前时间，<code>orginalStartTimeMs</code>则是整个<code>React</code>应用初始化时间（初始化时就创建，固定不变的常量），得到的**<code>currentTime</code>则是当前任务距离应用初始化时间的时间间隔**。</p> <p>最后得到<code>currentTime</code> 时间间隔进行<strong>取整处理，即(currentTime | 0)</strong>。</p></li> <li><p>接着计算<code>expirationTime</code>过期时间，该时间<strong>和优先级相关，值越大，优先级就越高</strong>。在方法<code>computeExpiration</code>中，其实就是<strong>将当前时间<code>performance.now()</code>加上一个优先级常量得到<code>expiration</code>过期时间</strong>。</p> <p>在<code>React</code>中共分为五种优先级，分别是</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">优先级</th> <th style="text-align:center;">优先级常量</th></tr></thead> <tbody><tr><td style="text-align:center;">ImmediatePriority（立即执行优先级）</td> <td style="text-align:center;">1</td> <td style="text-align:center;">-1</td></tr> <tr><td style="text-align:center;">UserBlockingPriority（用户交互优先级）</td> <td style="text-align:center;">2</td> <td style="text-align:center;">250</td></tr> <tr><td style="text-align:center;">NormalPriority（正常优先级）</td> <td style="text-align:center;">3</td> <td style="text-align:center;">5000</td></tr> <tr><td style="text-align:center;">LowPriority（低优先级）</td> <td style="text-align:center;">4</td> <td style="text-align:center;">10000</td></tr> <tr><td style="text-align:center;">IdlePriority（空闲优先级）</td> <td style="text-align:center;">5</td> <td style="text-align:center;">maxSigned31BitInt(约1073741823)</td></tr></tbody></table></li> <li><p>最后会创建一个<code>update</code>对象，该对象主要跟<code>setState</code>相关联，主要理解属性包括</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// update对象</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  expirationTime<span class="token punctuation">:</span> expirtationTime<span class="token punctuation">,</span> <span class="token comment">// 这次更新的过期时间</span>
  payload<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// setState的第一个参数</span>
  callback<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// setState的第二个参数</span>
  next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 用于寻找队列中的下一个节点</span>
  nextEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 用于执行队列中下一个节点的DOM相关操作</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>对于任何一个触发<code>render</code>的操作，都会创建一个<code>update</code>对象，使用队列方式进行存储，其中<code>next</code>属性就是用于查找下一个<code>update</code>节点</strong>。</p> <p>对于批量更新的过程中，由于创建多个<code>update</code>对象，在等到浏览器客户端空闲时，就会按优先级大小进行批量更新，但是也需要重点结合<code>expirationTime</code>过期时间，这个过程也是所谓的调度任务。（这也是能解释为什么多次调用<code>setState</code>，最后都只是更新一次～🤔）</p></li></ol> <h2 id="update（更新之调度任务）"><a href="#update（更新之调度任务）" class="header-anchor">#</a> Update（更新之调度任务）</h2> <p>先抛一个问题，当我们<code>setState</code>时，在后续取到的值依然是旧的值？相信大家都清楚，在<code>React</code>中会通过调度任务进行分配，那么<code>setState</code>由于后续需要批量更新，优先级不高，所以都会延后处理，这就导致为什么<code>setState</code>后取到的值依然是旧的值。</p> <p>那么问题来了，调度的作用是什么？</p> <p>我们知道，当点击一个按钮时，若<code>setState</code>更新状态，就会触发组件进行渲染，由于<code>js</code>是单线程的，若此时还要等待组件渲染结束后再去做一些关键<code>js</code>逻辑处理，只会让用户感觉到卡顿的感觉，为此，调度的作用就是来处理这些事情的。</p> <p>调度的作用就是，<strong><code>react</code>会根据任务的优先级计算出各自的<code>expirationTime</code>过期时间，然后根据过期时间逐个放入到一个队列中进行管理，当浏览器空闲时，就会先处理优先级高的任务，并且优先级高的任务可以中断优先级低的任务</strong>。</p> <p>那么剩下一个问题，它是如何实现的呢？</p> <p>答案就是<strong>根据任务优先级计算过期时间</strong>和<strong>通过<code>requestIdleCallback</code>方法</strong>。</p> <p>对于计算过期时间，在上面已经提及，现在就不再论述。</p> <p>现在就来看看<code>requestIdleCallback</code>方法，到底该方法做了哪些事情。</p> <p>该方法其实就是在浏览器空闲时期依次调用事件队列中的任务，内部实现采用的是宏任务<code>requestAnimationFrame</code>事件以及<code>setTimeout</code>定时器来实现的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>rAFID <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">timestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">localClearTimeout</span><span class="token punctuation">(</span>rAFTimeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">callback</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rAFTimeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">localCancelAnimationFrame</span><span class="token punctuation">(</span>rAFID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看到的是，当不支持<code>requestAnimationFrame</code>时，就会使用<code>setTimeout</code>进行补救～</p> <p>现在我们就来总结一下，调度任务的过程：</p> <ol><li>当有更新任务发生时，调度器会先根据策略分配其一个优先级，比如动画的优先级会高于更新状态优先级。</li> <li>接着根据分配好的优先级计算出过期时间（即当前时间 + 优先级），优先级越高那么时间就越近。</li> <li>计算好过期时间后就会存储到一个任务队列中。</li> <li>等待到浏览器空闲时，即主线程的代码都执行完后，接着调用<code>requestIdleCallback</code>方法来执行任务队列中方法，先判断任务过期时间是否过期，若过期则会立即优先执行该任务，若无则会按照优先级大小执行。</li></ol> <p>需要特别说明的是，在<code>React 15</code>版本之前，当组件更新时，就需要递归向下遍历整个虚拟<code>DOM</code>判断需要更新的地方，这种处理存在的弊端在于无法中断，必须更新完所有组件才会停止。因此在更新耗时长的过程中将会阻塞主线程，从而导致用户的交互、动画等不能及时响应。</p> <p>在<code>React 16</code>版本后，采用新的<code>Fiber</code>架构（即虚拟<code>DOM</code>升级版），将整个更新任务拆分成一个个小的任务，并且控制这些任务的执行。简单来说，<strong><code>Fiber</code>架构实现的就是，任务都是按照优先级高低执行，优先级高的任务可以中断优先级低任务</strong>。其<strong>核心包括<code>fiber</code>数据结构和调度器</strong>。</p> <p>在<code>diff</code>流程上，和<code>Vue</code>实现是差不多的，有兴趣的童鞋，可以看看我这篇文章<a href="https://github.com/Andraw-lin/about-Vue/blob/master/docs/%E3%80%90%20Vue%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20%E3%80%91%E5%A6%82%E4%BD%95%E5%9C%A8%E6%9B%B4%E6%96%B0%20Patch%20%E4%B8%AD%E8%BF%9B%E8%A1%8C%20Diff.md" target="_blank" rel="noopener noreferrer"> 【Vue 源码分析 】如何在更新 Patch 中进行 Diff<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/keep-Learning/react/react-learning-and-summary/React-Summary.html">
        React 知识点总结
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/keep-Learning/assets/js/app.90ccec97.js" defer></script><script src="/keep-Learning/assets/js/2.71580b53.js" defer></script><script src="/keep-Learning/assets/js/79.83c1ce53.js" defer></script>
  </body>
</html>
