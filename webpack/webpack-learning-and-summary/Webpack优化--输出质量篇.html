<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack 优化--输出质量篇 | Learing And Sharing</title>
    <meta name="description" content="好好学习，天天向上💪">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/keep-Learning/assets/css/0.styles.69d11f16.css" as="style"><link rel="preload" href="/keep-Learning/assets/js/app.90ccec97.js" as="script"><link rel="preload" href="/keep-Learning/assets/js/2.71580b53.js" as="script"><link rel="preload" href="/keep-Learning/assets/js/111.b05f070d.js" as="script"><link rel="prefetch" href="/keep-Learning/assets/js/10.99f30dcf.js"><link rel="prefetch" href="/keep-Learning/assets/js/100.53100d9a.js"><link rel="prefetch" href="/keep-Learning/assets/js/101.02f72051.js"><link rel="prefetch" href="/keep-Learning/assets/js/102.60bb996e.js"><link rel="prefetch" href="/keep-Learning/assets/js/103.c7f3df5b.js"><link rel="prefetch" href="/keep-Learning/assets/js/104.e8378220.js"><link rel="prefetch" href="/keep-Learning/assets/js/105.90235e89.js"><link rel="prefetch" href="/keep-Learning/assets/js/106.f4905ea3.js"><link rel="prefetch" href="/keep-Learning/assets/js/107.02dfbd1b.js"><link rel="prefetch" href="/keep-Learning/assets/js/108.e4ffed8c.js"><link rel="prefetch" href="/keep-Learning/assets/js/109.2f6191db.js"><link rel="prefetch" href="/keep-Learning/assets/js/11.ccfc084d.js"><link rel="prefetch" href="/keep-Learning/assets/js/110.05776fb6.js"><link rel="prefetch" href="/keep-Learning/assets/js/112.e07a4e74.js"><link rel="prefetch" href="/keep-Learning/assets/js/113.71af1d2b.js"><link rel="prefetch" href="/keep-Learning/assets/js/114.914195f4.js"><link rel="prefetch" href="/keep-Learning/assets/js/115.3a0e92aa.js"><link rel="prefetch" href="/keep-Learning/assets/js/116.4ab80baa.js"><link rel="prefetch" href="/keep-Learning/assets/js/12.5bee8056.js"><link rel="prefetch" href="/keep-Learning/assets/js/13.05de0df0.js"><link rel="prefetch" href="/keep-Learning/assets/js/14.d86b4a20.js"><link rel="prefetch" href="/keep-Learning/assets/js/15.887efa99.js"><link rel="prefetch" href="/keep-Learning/assets/js/16.f7c7fa8d.js"><link rel="prefetch" href="/keep-Learning/assets/js/17.dbf7a65f.js"><link rel="prefetch" href="/keep-Learning/assets/js/18.e57690bf.js"><link rel="prefetch" href="/keep-Learning/assets/js/19.7486ada7.js"><link rel="prefetch" href="/keep-Learning/assets/js/20.d9250e4c.js"><link rel="prefetch" href="/keep-Learning/assets/js/21.71046546.js"><link rel="prefetch" href="/keep-Learning/assets/js/22.5d1bafeb.js"><link rel="prefetch" href="/keep-Learning/assets/js/23.06f0e746.js"><link rel="prefetch" href="/keep-Learning/assets/js/24.2d27300f.js"><link rel="prefetch" href="/keep-Learning/assets/js/25.08ee3872.js"><link rel="prefetch" href="/keep-Learning/assets/js/26.b747bff1.js"><link rel="prefetch" href="/keep-Learning/assets/js/27.895e5c28.js"><link rel="prefetch" href="/keep-Learning/assets/js/28.8674bd28.js"><link rel="prefetch" href="/keep-Learning/assets/js/29.00b3c0e2.js"><link rel="prefetch" href="/keep-Learning/assets/js/3.227fd7b0.js"><link rel="prefetch" href="/keep-Learning/assets/js/30.7c8a2e90.js"><link rel="prefetch" href="/keep-Learning/assets/js/31.4e94fa86.js"><link rel="prefetch" href="/keep-Learning/assets/js/32.24db43de.js"><link rel="prefetch" href="/keep-Learning/assets/js/33.3a9d7c5b.js"><link rel="prefetch" href="/keep-Learning/assets/js/34.455ff1fa.js"><link rel="prefetch" href="/keep-Learning/assets/js/35.bf04ef16.js"><link rel="prefetch" href="/keep-Learning/assets/js/36.f733bfb6.js"><link rel="prefetch" href="/keep-Learning/assets/js/37.507ec8ee.js"><link rel="prefetch" href="/keep-Learning/assets/js/38.4c8024fc.js"><link rel="prefetch" href="/keep-Learning/assets/js/39.e5094649.js"><link rel="prefetch" href="/keep-Learning/assets/js/4.c62e84b3.js"><link rel="prefetch" href="/keep-Learning/assets/js/40.6dd7a473.js"><link rel="prefetch" href="/keep-Learning/assets/js/41.14db9a5d.js"><link rel="prefetch" href="/keep-Learning/assets/js/42.342c49d2.js"><link rel="prefetch" href="/keep-Learning/assets/js/43.e2f02df0.js"><link rel="prefetch" href="/keep-Learning/assets/js/44.85c43572.js"><link rel="prefetch" href="/keep-Learning/assets/js/45.2d71b584.js"><link rel="prefetch" href="/keep-Learning/assets/js/46.26841be2.js"><link rel="prefetch" href="/keep-Learning/assets/js/47.2be49ff6.js"><link rel="prefetch" href="/keep-Learning/assets/js/48.b0982983.js"><link rel="prefetch" href="/keep-Learning/assets/js/49.0160ec63.js"><link rel="prefetch" href="/keep-Learning/assets/js/5.c9cb8de9.js"><link rel="prefetch" href="/keep-Learning/assets/js/50.d1a3af12.js"><link rel="prefetch" href="/keep-Learning/assets/js/51.a655886f.js"><link rel="prefetch" href="/keep-Learning/assets/js/52.93851e74.js"><link rel="prefetch" href="/keep-Learning/assets/js/53.c8009c28.js"><link rel="prefetch" href="/keep-Learning/assets/js/54.7945804f.js"><link rel="prefetch" href="/keep-Learning/assets/js/55.0d1b82a0.js"><link rel="prefetch" href="/keep-Learning/assets/js/56.ea4f3968.js"><link rel="prefetch" href="/keep-Learning/assets/js/57.c7fe55e7.js"><link rel="prefetch" href="/keep-Learning/assets/js/58.e2e1b6dd.js"><link rel="prefetch" href="/keep-Learning/assets/js/59.195b09a3.js"><link rel="prefetch" href="/keep-Learning/assets/js/6.7294f365.js"><link rel="prefetch" href="/keep-Learning/assets/js/60.b0c6ca2b.js"><link rel="prefetch" href="/keep-Learning/assets/js/61.d8137606.js"><link rel="prefetch" href="/keep-Learning/assets/js/62.354a6c3b.js"><link rel="prefetch" href="/keep-Learning/assets/js/63.42a16259.js"><link rel="prefetch" href="/keep-Learning/assets/js/64.44130cd9.js"><link rel="prefetch" href="/keep-Learning/assets/js/65.826334d1.js"><link rel="prefetch" href="/keep-Learning/assets/js/66.39bd2327.js"><link rel="prefetch" href="/keep-Learning/assets/js/67.89147bbe.js"><link rel="prefetch" href="/keep-Learning/assets/js/68.a7602bd4.js"><link rel="prefetch" href="/keep-Learning/assets/js/69.028f1340.js"><link rel="prefetch" href="/keep-Learning/assets/js/7.a9fa44ec.js"><link rel="prefetch" href="/keep-Learning/assets/js/70.3bb91667.js"><link rel="prefetch" href="/keep-Learning/assets/js/71.65fb15dd.js"><link rel="prefetch" href="/keep-Learning/assets/js/72.00066c85.js"><link rel="prefetch" href="/keep-Learning/assets/js/73.47b522ff.js"><link rel="prefetch" href="/keep-Learning/assets/js/74.7a6ef089.js"><link rel="prefetch" href="/keep-Learning/assets/js/75.b187d3a1.js"><link rel="prefetch" href="/keep-Learning/assets/js/76.88a347ac.js"><link rel="prefetch" href="/keep-Learning/assets/js/77.6f86a34a.js"><link rel="prefetch" href="/keep-Learning/assets/js/78.d0ed26d6.js"><link rel="prefetch" href="/keep-Learning/assets/js/79.83c1ce53.js"><link rel="prefetch" href="/keep-Learning/assets/js/8.acbc06dd.js"><link rel="prefetch" href="/keep-Learning/assets/js/80.a48aa37a.js"><link rel="prefetch" href="/keep-Learning/assets/js/81.6eacd104.js"><link rel="prefetch" href="/keep-Learning/assets/js/82.25ef373b.js"><link rel="prefetch" href="/keep-Learning/assets/js/83.09550954.js"><link rel="prefetch" href="/keep-Learning/assets/js/84.e8671abc.js"><link rel="prefetch" href="/keep-Learning/assets/js/85.b1b7d209.js"><link rel="prefetch" href="/keep-Learning/assets/js/86.d297bac9.js"><link rel="prefetch" href="/keep-Learning/assets/js/87.eeea66b3.js"><link rel="prefetch" href="/keep-Learning/assets/js/88.0ea72a36.js"><link rel="prefetch" href="/keep-Learning/assets/js/89.4155e98e.js"><link rel="prefetch" href="/keep-Learning/assets/js/9.ad2f8d07.js"><link rel="prefetch" href="/keep-Learning/assets/js/90.611a7011.js"><link rel="prefetch" href="/keep-Learning/assets/js/91.e84d85cf.js"><link rel="prefetch" href="/keep-Learning/assets/js/92.30b75a79.js"><link rel="prefetch" href="/keep-Learning/assets/js/93.0ccb8db1.js"><link rel="prefetch" href="/keep-Learning/assets/js/94.f5e0fbaf.js"><link rel="prefetch" href="/keep-Learning/assets/js/95.7e23aad8.js"><link rel="prefetch" href="/keep-Learning/assets/js/96.654c8e0c.js"><link rel="prefetch" href="/keep-Learning/assets/js/97.b65e23fb.js"><link rel="prefetch" href="/keep-Learning/assets/js/98.e14a8d6c.js"><link rel="prefetch" href="/keep-Learning/assets/js/99.e2ce5525.js">
    <link rel="stylesheet" href="/keep-Learning/assets/css/0.styles.69d11f16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/keep-Learning/" class="home-link router-link-active"><!----> <span class="site-name">Learing And Sharing</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/keep-Learning/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分享" class="dropdown-title"><span class="title">技术分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/keep-Learning/javascript/javascript-learning-and-summary/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/html/html-learning-and-summary/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/css/css-learning-and-summary/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/webpack/webpack-learning-and-summary/" class="nav-link router-link-active">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/ts/ts-learning-and-summary/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/nodejs/nodejs-learning-and-summary/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/weex/weex-learning-and-summary/" class="nav-link">
  Weex
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/network/network-learning-and-summary/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/datastructure/datastructure-learning-and-summary/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/mixin/mixin-learning-and-summary/" class="nav-link">
  日常杂记
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Andraw-lin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/keep-Learning/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术分享" class="dropdown-title"><span class="title">技术分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/keep-Learning/javascript/javascript-learning-and-summary/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/html/html-learning-and-summary/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/css/css-learning-and-summary/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/webpack/webpack-learning-and-summary/" class="nav-link router-link-active">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/ts/ts-learning-and-summary/" class="nav-link">
  Typescript
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/nodejs/nodejs-learning-and-summary/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/weex/weex-learning-and-summary/" class="nav-link">
  Weex
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/network/network-learning-and-summary/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/datastructure/datastructure-learning-and-summary/" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/keep-Learning/mixin/mixin-learning-and-summary/" class="nav-link">
  日常杂记
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Andraw-lin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/keep-Learning/webpack/webpack-learning-and-summary" class="sidebar-heading clickable router-link-active open"><span>Webpack 学习和总结</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack究竟是如何运行的.html" class="sidebar-link">Webpack究竟是如何运行的</a></li><li><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--构建速度篇.html" class="sidebar-link">Webpack优化--构建速度篇</a></li><li><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--开发体验篇.html" class="sidebar-link">Webpack优化--开发体验篇</a></li><li><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html" class="active sidebar-link">Webpack优化--输出质量篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#使用process区分环境" class="sidebar-link">使用process区分环境</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#利用uglifyjs对javascript压缩，利用cssnano对css压缩" class="sidebar-link">利用UglifyJS对JavaScript压缩，利用cssnano对css压缩</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#配置publicpath指向cdn服务加速" class="sidebar-link">配置publicPath指向CDN服务加速</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#使用tree-shaking去除多余的无用代码" class="sidebar-link">使用Tree-Shaking去除多余的无用代码</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#提取公共代码和第三方代码" class="sidebar-link">提取公共代码和第三方代码</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#提取懒加载代码（即按需加载的代码）" class="sidebar-link">提取懒加载代码（即按需加载的代码）</a></li><li class="sidebar-sub-header"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--输出质量篇.html#开启scope-hoisting" class="sidebar-link">开启Scope Hoisting</a></li></ul></li><li><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack之模块化优化.html" class="sidebar-link">Webpack之模块化优化</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack-优化-输出质量篇"><a href="#webpack-优化-输出质量篇" class="header-anchor">#</a> Webpack 优化--输出质量篇</h1> <p>我们都知道，使用 Webpack 打包后的文件大小，会直接影响到线上用户的体验，如首屏加载时间，包越大时相应的打开时长也会越长，毕竟还是需要时间和网络下载一个包的。😅</p> <p>那么，我们应该如何去使用 Webpack 更好滴优化打包后的文件呢？接下来我就来简单讲解一些常用方法。</p> <h2 id="使用process区分环境"><a href="#使用process区分环境" class="header-anchor">#</a> 使用process区分环境</h2> <p>在我们开发 web 时，一般都会分为两个环境，分别是开发环境和生产环境。开发环境就是用于开发者开发时调试使用的，而生产环境则是针对真实用户使用的。</p> <p><strong>Webpack 已经内置了区分环境功能，当代码中使用 process 模块的语句时，Webpack 就会自动打包进 process 模块的代码以支持非 Node.js 环境</strong>。因此，我们可以直接在代码中这样区分环境。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'生产环境'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开发环境'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Webpack 4 里，已经支持使用 mode 属性来配置环境。当然也可以如下配置。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> DefinePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/DefinePlugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'process.env'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token constant">NODE_ENV</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述配置中，为什么要使用 JSON.stringify 方法定义？环境变量的值必须是一个由双引号包裹的字符串，即&quot;'production'&quot;。</p> <p>另外，也可以直接在 Webpack 执行命令上带上环境参数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>webpack <span class="token constant">NODE_ENV</span><span class="token operator">=</span>production
</code></pre></div><p>这时候在上面的 new DefinePlugin 中就需要这样去获取环境参数进行定义。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'process.env.NODE_ENV'</span><span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="利用uglifyjs对javascript压缩，利用cssnano对css压缩"><a href="#利用uglifyjs对javascript压缩，利用cssnano对css压缩" class="header-anchor">#</a> 利用UglifyJS对JavaScript压缩，利用cssnano对css压缩</h2> <p>在性能提升方面，相信我们都会知道使用 GZip 对文件进行压缩，那么对于文件内容进行压缩则可以选用 UglifyJS，同时 Webpack 已经内置 UglifyJS。</p> <p>在这里，可以使用 ParallelUglifyJS 开启多个进程对代码进行压缩来加快构建进程，但是 ParallelUglifyJS 底层都是使用 UglifyJS 进行工作的，所以我们有必要了解一下如何使用 UglifyJS 进行代码压缩。</p> <p><strong>使用 UglifyJS 对代码进行压缩时，除了可以提升网页加载的速度，还可以混淆源码</strong>。</p> <p>UglifyJS 的基本原理就是，<strong>分析 Javascript 代码语法树，理解代码的含义，从而做到去掉无效代码、去掉日志输出代码、缩短变量名等优化</strong>。</p> <p>UglifyJS 中常用的选项如下：</p> <ul><li>sourceMap：是否为压缩后的代码生成对应的 Source Map，默认不生成，开启后耗时会大大增加。</li> <li>output.beautify：是否要保留空格和制表符，默认为保留，为了达到更好的压缩效果，可设置 false。</li> <li>output.comments：是否保留代码中的注释，默认保留，可设置为 false。</li> <li>compress.warning：是否删除没有用到的输出警告信息，默认为输出，可设置为 false。</li> <li>compress.drop_console：是否删除代码中所有的console语句。</li> <li>compress.collapse_vars：是否内嵌虽然已定义但是只用到一次的变量，如 var x = 5; y = x; 转换成 y = 5，默认为不转换，可设置为 true。</li> <li>compress.reduce_vars：是否提取出现多次但是没定义成变量去引用的静态值。如 x = 1; y = 1; 转换成 var a = 1; x = a; y = a，默认不转换，可以设置为 true。</li></ul> <p>对于使用 UglifyJs 进行配置如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> UglifyJsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/optimize/UglifyJsPlugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      compress<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        collapse_vars<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        reduce_vars<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        beautify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        comments<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Webpack 内置的 UglifyJsPlugin 用的是 UglifyJS2。<strong>当执行 webpack --optimize-minimize 命令时，会自动注入 UglifyJSPlugin</strong>。</p> <p>需要注意的是，<strong>UglifyJS 只理解 ES5 语法的代码，因此一般是需要结合 Babel 一起使用。若只是单纯压缩 ES6 代码，则需要用到 UglifyES</strong>。</p> <p>如果需要在 Webpack 接入 UglifyES，则需要单独安装最新版的 uglifyjs-webpack-plugin。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm i <span class="token operator">-</span><span class="token constant">D</span> uglifyjs<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin@beta

<span class="token comment">// 配置如下</span>
<span class="token keyword">const</span> UglifyEsPlugin <span class="token operator">=</span> <span class="token function">reqire</span><span class="token punctuation">(</span><span class="token string">'uglifyjs-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">UglifyEsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      compress<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        drop_console<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        collapse_vars<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        reduce_vars<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        beautify<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        comments<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>在接入 UglifyES 时，需要 babel-loader 不能转换 ES5 代码，即需要在 .babelrc 中去掉 babel-preset-env</strong>。</p> <p>既然 JavaScript 代码可以压缩，那么 css 代码能否也压缩一下？</p> <p><strong>如果压缩 css 代码，需要用到的压缩工具则是 cssnano，基于 PostCSS 实现的</strong>。</p> <p>举个例子，在 css 中，margin: 10px 20px 10px 20px; 会被转换成 margin: 10px 20px; 、color: #000 转换成 color: black;。</p> <p>那么在 Webpack 中怎么接入 cssnano 呢？</p> <p>其实<strong>在 css-loader 中已经内置了 cssnano，若需开启，则只需要加上 minimize 选项即可</strong>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rule<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
        use<span class="token punctuation">:</span> ExtractTextPlugin<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'css-loader?minimize'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="配置publicpath指向cdn服务加速"><a href="#配置publicpath指向cdn服务加速" class="header-anchor">#</a> 配置publicPath指向CDN服务加速</h2> <p>相信大家对 CDN 并不陌生，<strong>CDN 可以加速网络传输，通过将资源部署到世界各地，使用户在访问时按照就近原则从离最近的服务器上获取资源，从而加快资源的获取</strong>。</p> <p>在项目中常用的 CDN 方式是如下：</p> <ul><li><strong>对于项目中 HTML 文件，直接放在项目根目录下储存，而不是放到 CDN 服务上</strong>，同时需要关闭项目服务器的缓存，项目服务器只提供 HTML 文件和数据接口。</li> <li><strong>针对打包好的 JavaScript、CSS、图片等静态文件，都放在 CDN 服务上，并开启 CDN 缓存</strong>，同时为每个文件带上一个 hash 值，如 a.asvf1231sd.js 文件。带上 hash 原因是，当发版新的代码到生产上，避免用户依旧使用的是旧版代码，每次发版都会更新相应的 hash 值告诉浏览器拉取最新的代码。</li></ul> <p>由于浏览器有一个规则是，<strong>在同一时刻针对同一个域名的资源的并行请求有限制，一般为 4 个左右，不同的浏览器可能不同</strong>。<strong>为了避免将所有的 JavaScript、CSS、图片等静态文件只放在一个服务上，可以尝试将这些静态资源分散到不同的 CDN 服务上</strong>。（即 JavaScript 文件放到单独的 js CDN 服务上，CSS 文件放到单独的 css CDN 服务上）</p> <p>既然如此，Webpack 应该如何接入 CDN 呢？要接入 CDN 服务，需要实现以下几点。</p> <ul><li>使用 publicPath 指向 CDN 服务的绝对路径地址，而不是指向项目的服务地址上。</li> <li>静态资源的文件名需要带上相应的 hash 值，避免被缓存。</li> <li>将不同类似的资源放到不同的 CDN 服务上，避免资源的并行下载限制。</li></ul> <p>直接看看在 Webpack 中如何配置的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ExtractTextPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'extract-text-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>WebPlugin<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'web-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  output<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> <span class="token string">'[name]_[chunkhash:8].js'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 指定存放JavaScript文件的CDN服务地址</span>
    publicPath<span class="token punctuation">:</span> <span class="token string">'//js.cdn.com/id'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
        use<span class="token punctuation">:</span> ExtractTextPlugin<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'css-loader?minimize'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token comment">// 指定存放CSS中导入的资源（如图片）的CDN服务地址</span>
          publicPath<span class="token punctuation">:</span> <span class="token string">'//img.cdn.com/id'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/\.png$/</span><span class="token punctuation">,</span>
        <span class="token comment">// 为输入的PNG文件加上Hash值，并指定hash的长度为8位</span>
        use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'file-loader?name=[name]_[hash:8].text'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">WebPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// HTML模板所在位置</span>
      template<span class="token punctuation">:</span> <span class="token string">'./template.html'</span><span class="token punctuation">,</span>
      <span class="token comment">// 输出的HTML文件名</span>
      filename<span class="token punctuation">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
      <span class="token comment">// 指定存放css文件的CDN服务地址</span>
      stylePublic<span class="token punctuation">:</span> <span class="token string">'//css.cdn.com/id/'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ExtractTextPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 为输出的CSS文件名加上hash值，并指定hash的长度为8位</span>
      filename<span class="token punctuation">:</span> <span class="token string">'[name]_[contentHash:8]'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="使用tree-shaking去除多余的无用代码"><a href="#使用tree-shaking去除多余的无用代码" class="header-anchor">#</a> 使用Tree-Shaking去除多余的无用代码</h2> <p><strong>Tree Shaking 可用于剔除 JavaScript 中用不上的死代码，是基于静态的 ES6 模块化语法的</strong>（即依赖于 import 和 export）。</p> <p>简单滴来说，Tree Shaking 不支持其他模块化如 RequireJS、CommonJS 等。</p> <p>接下来就来看看，是如何配置 Tree Shaking 的。🤔</p> <p>首先，需要在 babel 的配置下，禁止 ES6 模块化转换成 ES5 的形式，因此在 .babelrc 文件中配置如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;presets&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;modules&quot;</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述的 <strong>modules: false 的含义就是关闭 babel 的模块转换功能，保留原本的 ES6 模块化语法</strong>。</p> <p>从 Webpack 2.0 开始，Webpack 自带 Tree Shaking 功能。另外，在执行 webpack 命令时带上 --display-used-exports 参数，可追踪 Tree Shaking 的工作。</p> <p><strong>Webpack 只是指出哪些函数被用上，而哪些函数没被用上，以及腰剔除用不上的代码，则还要经过 UglifyJS 处理一番。</strong></p> <p>在使用大量的第三方库时，会发现 Tree Shaking 似乎并不生效，原因是大部分 NPM 包中的代码都采用了 CommonJS 模块化语法。当然有些库已经考虑到这一点，在发布到 NPM 上时会同时提供两份代码，一份用于 CommonJS 模块化语法，一份采用 ES6 模块化语法，并且在 package.json 文件中会分别指出这两份代码的入口。</p> <p>以 Redux 为例，在其 package.json 中会这样指明入口：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token string">&quot;main&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;lib/index.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 指明采用CommonJS模块化的代码入口</span>
	<span class="token string">&quot;jsnext:main&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;es/index.js&quot;</span> <span class="token comment">// 指明采用ES6模块化的代码入口</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在前面已经提到过，resolve.mainFields 用于配置采用哪个字段作为模块的入口描述，因此，为了让 Tree Shaking 对上面的 Redux 有效，需要配置如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对NPM中的第三方模块优先采用jsnext:main中指向ES6模块化语法的文件</span>
    mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'jsnext:main'</span><span class="token punctuation">,</span> <span class="token string">'browser'</span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>采用 jsnext:main 作为 ES6 模块化代码的入口是社区的一个约定。</p> <h2 id="提取公共代码和第三方代码"><a href="#提取公共代码和第三方代码" class="header-anchor">#</a> 提取公共代码和第三方代码</h2> <p>当每个页面的代码都将公共的代码包含进去，就会造成：</p> <ul><li>相同的资源被重复加载，浪费用户的流量和服务器的成本；</li> <li>每个页面需要加载的资源太大，导致网页首屏加载缓慢，影响用户体验；</li></ul> <p>需要说明的是，<strong>在 Webpack 3.0 中使用插件 CommonChunkPlugin 提取公共部分，在 Webpack 4.0 后则需要在 optimization.splitChunk 中进行配置提取公共部分</strong>。在官方文档中提到，虽然 CommonChunkPlugin 可用来避免使用重复的依赖，但若想进一步的优化是不可能的。</p> <p>通常情况下，会按照以下规则进行提取公共代码。</p> <ul><li>将项目中所用到的<strong>第三方代码统一打包</strong>到一个文件中（如vendors.js）。</li> <li>在剔除第三方代码后，再找出<strong>所有页面都依赖的公共部分代码</strong>，将它们提取出来并放到一个文件中（如commons.js）。</li> <li>最后再为每个页面都生成一个单独的文件，在这个文件中不再包含第三方代码以及公共部分代码。</li></ul> <p>也许你会觉得很奇怪，为什么不可以将第三方代码都放到公共部分代码中去？</p> <p>其实就是为了<strong>长期缓存第三方代码</strong>。由于第三方代码是基本不会更新，相反页面依赖的公共部分代码则会根据业务需求的不同而发生变化，因此需区别对待。</p> <p>现在我们就来看看，在 Webpack 4.0 中是如何进行提取第三方代码和页面依赖的公共部分代码的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    splitChunks<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      chunks<span class="token punctuation">:</span> <span class="token string">'initial'</span><span class="token punctuation">,</span> <span class="token comment">// 表示同步模块，有三个值，分别是initial(初始化，打包第三方代码用到)、all(所有块)、async(异步块，按需加载用到) </span>
      minSize<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>  <span class="token comment">// 块的最小值</span>
      maxSize<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 块的最大值</span>
      minChunks<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 拆分前必须共享模块的最小块数</span>
      maxAsyncRequests<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 按需加载时最大并行请求数</span>
      maxInitialRequests<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 入口点的最大并行请求数</span>
      automaticNameDelimiter<span class="token punctuation">:</span> <span class="token string">'~'</span><span class="token punctuation">,</span> <span class="token comment">// 默认情况下，webpack将使用块的来源和名称生成名称（如vendors～main.js）</span>
      name<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 拆分块的名称，提供true将基于块和缓存组密钥自动生成一个名称</span>
      cacheGroups<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 缓存模块</span>
        vendors<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 基本框架</span>
          chunks<span class="token punctuation">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
          test<span class="token punctuation">:</span> <span class="token regex">/(react|react-dom|react-dom-router|babel-polyfill|mobx)/</span><span class="token punctuation">,</span>
          priority<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">'vendors'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        d3Venodr<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 将体积较大的d3单独提取包，指定页面需要的时候再异步加载</span>
          test<span class="token punctuation">:</span> <span class="token regex">/d3/</span><span class="token punctuation">,</span>
          priority<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 设置高于async-commons，避免打包到async-common中</span>
          name<span class="token punctuation">:</span> <span class="token string">'d3Venodr'</span><span class="token punctuation">,</span>
          chunks<span class="token punctuation">:</span> <span class="token string">'async'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        echartsVenodr<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 异步加载echarts包</span>
          test<span class="token punctuation">:</span> <span class="token regex">/(echarts|zrender)/</span><span class="token punctuation">,</span>
          priority<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 高于async-commons优先级</span>
          name<span class="token punctuation">:</span> <span class="token string">'echartsVenodr'</span><span class="token punctuation">,</span>
          chunks<span class="token punctuation">:</span> <span class="token string">'async'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'async-commons'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 其余异步组件加载包</span>
          chunks<span class="token punctuation">:</span> <span class="token string">'async'</span><span class="token punctuation">,</span>
          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">'async-commons'</span><span class="token punctuation">,</span>
          priority<span class="token punctuation">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        commons<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 其余同步加载包</span>
          chunks<span class="token punctuation">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
          minChunks<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          name<span class="token punctuation">:</span> <span class="token string">'commons'</span><span class="token punctuation">,</span>
          priority<span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于 splitChunks 中的 chunks，需要说明的是：</p> <ul><li>all：不管文件是动态还是非动态载入，统一将文件分离。当页面首次载入会引入所有的包。</li> <li>inital：将异步和非异步的文件分离，如果一个文件被异步引入也被非异步引入，那它会被打包两次（注意和all区别），用于分离页面首次需要加载的包。（<strong>第三方代码引入</strong>）。</li> <li>async：将异步加载的文件分离，首次一般不引入，到需要异步引入的组件才会引入（即<strong>按需引入</strong>）。</li></ul> <h2 id="提取懒加载代码（即按需加载的代码）"><a href="#提取懒加载代码（即按需加载的代码）" class="header-anchor">#</a> 提取懒加载代码（即按需加载的代码）</h2> <p>在上面使用 splitChunkPlugin 提取代码中，其实已经有提及到对懒加载代码的提取，就是 chunk 值为 async 。</p> <p>相信用过 React、Vue 的童鞋们，肯定对 import() 方法不陌生，它就是用来实现组件的懒加载的。</p> <p><strong>import() 返回一个 Promise，依赖于 Promise</strong>。下面就使用 React-Router 实现组件懒加载栗子。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span>PureComponent<span class="token punctuation">,</span> createElement<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDom <span class="token keyword">from</span> <span class="token string">'react-dom'</span>

<span class="token keyword">function</span> <span class="token function">getAsyncComponent</span><span class="token punctuation">(</span><span class="token parameter">load</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">AsyncComponent</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> component <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          component
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>component<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
      <span class="token keyword">return</span> component <span class="token operator">?</span> <span class="token function">createElement</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
  	<span class="token operator">&lt;</span>HashRouter<span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    		<span class="token operator">&lt;</span>nav<span class="token operator">&gt;</span><span class="token operator">&lt;</span>link to<span class="token operator">=</span><span class="token string">&quot;/about&quot;</span><span class="token operator">&gt;</span>About<span class="token operator">&lt;</span><span class="token operator">/</span>link<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nav<span class="token operator">&gt;</span>
    	<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">&quot;/about&quot;</span> component<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">getAsyncComponent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: about */</span> <span class="token string">'./pages/about'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Route<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>HashRouter<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码需要在 Webpack 中配置好相应的 babel-loader，将源码先提交给 babel-loader 处理，再提交给 Webpack 处理其中的 import(*) 语句。但是由于 babel-loader 并不认识 import(*) 语句，因此会报错。</p> <p>为了让 babel-loader 处理 import(*) 语句，需要安装一个 babel 插件 babel-plugin-syntax-dynamic-import。需在 .babelrc 文件做如下配置。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;presets&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;react&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;plugins&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;syntax-dynamic-import&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="开启scope-hoisting"><a href="#开启scope-hoisting" class="header-anchor">#</a> 开启Scope Hoisting</h2> <p>Scope Hoisting 可以让 Webpack 打包出来的代码文件更小、运行更快，又称为作用域提升。</p> <p><strong>Scope Hoisting 实现的基本原理是，分析模块之间的依赖关系，尽可能将被打散的模块合并到一个函数中，但前提是不能造成代码冗余</strong>。</p> <p>那么要开启 Scope Hoisting，在 Webpack 中如何配置呢？<strong>只需要用到内置的 ModuleConcatenationPlugin 插件即可开启 Scope Hoisting</strong>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> ModuleConcatenationPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/lib/optimize/ModuleConcatenationPlugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要注意的是，Scope Hoisting 依赖源码时需采用 ES6 模块化代码，还需配置 resolve.mainFields。因为大部分 NPM 包的第三方库都是采用 CommomJS 语法，因此需配置 resolve.mainFields 指向使用 ES6 模块化代码。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  resolve<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    mainFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'jsnext:main'</span><span class="token punctuation">,</span> <span class="token string">'browser'</span><span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然，对于采用了非 ES6 模块化的代码，Webpack 则会降级处理且不使用 Scope Hoisting 进行优化。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack优化--开发体验篇.html" class="prev">
        Webpack优化--开发体验篇
      </a></span> <span class="next"><a href="/keep-Learning/webpack/webpack-learning-and-summary/Webpack之模块化优化.html">
        Webpack之模块化优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/keep-Learning/assets/js/app.90ccec97.js" defer></script><script src="/keep-Learning/assets/js/2.71580b53.js" defer></script><script src="/keep-Learning/assets/js/111.b05f070d.js" defer></script>
  </body>
</html>
